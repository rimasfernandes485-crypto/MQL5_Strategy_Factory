name: ğŸ” ValidaÃ§Ã£o AutomÃ¡tica MQL5 (Base44 â†’ GitHub)

on:
  push:
    branches:
      - main
    paths:
      - 'Experts/**/*.mq5'
      - 'Include/**/*.mqh'

jobs:
  validar_codigo:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Faz o download do repositÃ³rio
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Instala Python (usado para analisar a estrutura dos cÃ³digos)
      - name: âš™ï¸ Configurar ambiente Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3ï¸âƒ£ Instala dependÃªncias bÃ¡sicas
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          pip install lxml pygments

      # 4ï¸âƒ£ Executa a verificaÃ§Ã£o sintÃ¡tica dos arquivos .mq5 e .mqh
      - name: ğŸ” Validar estrutura dos cÃ³digos MQL5
        run: |
          echo "Iniciando validaÃ§Ã£o de sintaxe dos arquivos MQL5..."
          python3 <<'EOF'
import os, re, sys

def validar_codigo(codigo):
    erros = []
    if not "#property" in codigo:
        erros.append("Falta a diretiva #property no inÃ­cio.")
    if not re.search(r'(OnInit|OnDeinit|OnTick)', codigo):
        erros.append("Falta uma das funÃ§Ãµes principais (OnInit, OnDeinit, OnTick).")
    if codigo.count('{') != codigo.count('}'):
        erros.append("NÃºmero desigual de chaves '{' e '}'.")
    if "CTrade" not in codigo and "OrderSend" not in codigo:
        erros.append("Nenhuma funÃ§Ã£o de negociaÃ§Ã£o encontrada (CTrade ou OrderSend).")
    return erros

base_dirs = ["Experts", "Include"]
total_erros = 0

for pasta in base_dirs:
    for root, _, files in os.walk(pasta):
        for f in files:
            if f.endswith((".mq5", ".mqh")):
                caminho = os.path.join(root, f)
                with open(caminho, "r", encoding="utf-8", errors="ignore") as arq:
                    conteudo = arq.read()
                erros = validar_codigo(conteudo)
                if erros:
                    print(f"\nâŒ Erros em {caminho}:")
                    for e in erros:
                        print("   -", e)
                    total_erros += 1

if total_erros == 0:
    print("\nâœ… Nenhum erro crÃ­tico encontrado nos cÃ³digos MQL5.")
else:
    print(f"\nâš ï¸ Total de arquivos com problemas: {total_erros}")
    sys.exit(1)
EOF

      # 5ï¸âƒ£ Mostra status final da validaÃ§Ã£o
      - name: âœ… Resultado da verificaÃ§Ã£o
        if: success()
        run: echo "ValidaÃ§Ã£o concluÃ­da com sucesso. CÃ³digos prontos para backtest!"

